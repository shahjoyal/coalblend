<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coal Blending Ratio — light theme</title>
     <style>
    :root{
      --bg: #F7F8FA;        
      --card: #FFFFFF;      
      --muted: #6b7280;     
      --text: #111827;      
      --accent: #b71c1c;    /* red */
      --green: #16a34a;     /* green */
      --border: #E5E7EB;    
      --input-border: #D1D5DB; 
      --accent-btn: #0f4db2;
      --color-blue-800: oklch(.424 .199 265.638);
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 90px 14px 8px; /* top padding increased for navbar */
      /* allow normal page scrolling */
      overflow-x: hidden;
    }

    h1 {
      color: var(--text);
      margin: 8px 0;
      font-size: 1.3rem;
      text-align: left;
    }

    .upload-btn {
      display: inline-block;
      background: #02008a;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 6px 3px;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-size: 0.85rem;
    }

    .main-container {
      display:flex;
      flex-direction:column;
      gap:14px;
      max-width: 1000px;
      align-items:flex-start;
      
    }

    /* grid: first column is label, next 8 are mills/bunkers + gcv + cost */
    .mills-grid {
      display: grid;
      grid-template-columns: 140px repeat(8, 1fr);
      gap: 6px;
      margin: 8px 0;
      align-items: center;
      font-size: 0.8rem;
      width: 100%;
    }

    .mill {
      background: var(--card);
      border: 1px solid var(--border);
      text-align: center;
      padding: 6px;
      color: var(--text);
      min-height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 1px 2px rgba(16,24,40,0.03);
      border-radius: 6px;
    }

    /* red state (when sum == 100) */
    .mill.red {
      background: var(--accent);
      color: #fff;
      font-weight:700;
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* green state (default when sum < 100) */
    .mill.green {
      background: var(--green);
      color: #fff;
      font-weight:700;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .mill.coal-flow,
    .mill.gcv,
    .mill.aft-head,
    .mill.cost-head {
      background: #02008a;
      color: #fff;
      font-weight: 600;
    }

    .dropdown {
      width: 105%;
      padding:8px;
      background: #fff;
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.8rem;
    }

    .percentage-input, .flow-input, .cost-input, .generation-input {
      width: 88%;
      padding:6px;
      background: #fff;
      border:1px solid var(--input-border);
      color: var(--text);
      text-align:center;
      border-radius: 4px;
      box-sizing: border-box;
      outline: none;
      font-size: 0.8rem;
    }

    .percentage-input{
      border:2px solid #02008a
    }

    .percentage-input::placeholder, .flow-input::placeholder, .cost-input::placeholder {
      color: var(--muted);
    }
.flow-input{
  border:2px solid #F1C40F
}

.generation-input{
  border:2px solid #F1C40F
}
    .cost-input { border:2px solid #F1C40F; background:#fff; }

    .gcv-box {
      width: 92%;
      padding:6px;
      text-align:center;
      font-weight:700;
      background:#F3F4F6;
      border:1px solid var(--input-border);
      color: var(--text);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.8rem;
    }

    .aft { min-height: 28px; color: var(--text); }

    .summary-table {
      display: grid;
      grid-template-columns: 140px 110px;
      gap:6px;
      width:260px;
      margin-bottom:14px;
      font-size: 0.8rem;
      background: transparent;
    }

    .summary-cell {
      background: var(--card);
      border:1px solid var(--border);
      padding:8px;
      color:var(--text);
      text-align:center;
      border-radius:6px;
    }

    .summary-header {
      background:#F3F4F6;
      font-weight:700;
      color:var(--text);
    }

    .summary-cell.summary-header {
      background: #02008a;
      font-weight: 700;
      color: #fff;
    }

   .navbar {
            
            width: 100%;
            background-color: #f7f8fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 65px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .navbar img {
            height: 95px;
            margin-right: 10px;
            margin-left: 0px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px; /* Use 'gap' for spacing between flex items */
            margin-right: 20px;
            
        }

        .navbar h1 {
            margin-left: 0px;
            font-size: 20px; /* Adjust font size as needed */
            color: black;
            
        }

       .navbar button {
            padding: 10px 15px;
            background-color: #02008a;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 20px;
            font-weight: bold;
        }
        
        .navbar button:hover {
            background-color: #001cbb;
        }
    /* compact adjustments to avoid scrolling */
    body {
      padding: 80px 6px 6px; /* reduce padding */
    }

    .mills-grid {
      gap: 4px;
      font-size: 0.72rem;
    }

    .mill {
      padding: 4px;
      min-height: 28px;
      font-size: 0.72rem;
    }

    .dropdown,
    .percentage-input,
    .flow-input,
    .cost-input,
    .gcv-box,
    .generation-input {
      font-size: 0.72rem;
      padding: 4px;
    }
    .dropdown {
  font-size:0.6rem;
    }
       #downloadPDF {
  position: fixed;
  top: 100px;
  right: 20px;
  background: #02008a; 
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
  z-index: 9999; /* keeps it above everything */
}

#downloadPDF:hover {
  background: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.2);
}
.navbar .logout-btn {
  padding: 10px 16px;
  background-color: red !important;
  color: #fff !important;
  border: none;
  cursor: pointer;
  border-radius: 25px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.navbar .logout-btn:hover {
  background-color: darkred !important;
}
  .icon-btn {
  background: #02008a;  /* same as navbar */
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}


/* Tooltip */
.icon-btn::after {
  content: attr(title);
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: #000;
  color: #fff;
  font-size: 12px;
  padding: 5px 8px;
  border-radius: 6px;
  opacity: 0;
  white-space: nowrap;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.icon-btn:hover::after {
  opacity: 1;
}

/* layout styles used inside grid cell */
.layout {
    position: relative;
    transform-origin: top left;
}

/* bunker grid inside the layout - aligned to the 6 bunker columns */
.bunkers-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 18px;
  align-items: end;
}

.bunker {
  width: 100%;
  max-width: 120px;
  height: 160px;
  position: relative;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.bunker svg {
  width: 100%;
  height: 120px;
}

.bunker path {
  fill: none;
  stroke: black;
  stroke-width: 2px;
}

.label {
  text-align: center;
  margin-top: -6px;
  font-weight: bold;
}

/* top horizontal line and arrows now positioned relative to the layout wrapper */
.layout .top-line {
  position: absolute;
  top: 0;
  left: -10px; /* start a bit earlier than first arrow */
  width: 590px; /* adjust width to still end at last arrow */
  height: 2px;
  background: black;
}

.layout .arrow {
      position: absolute;
      width: 2px;
      background: black;
}

.layout .arrow::after {
      content: '';
      position: absolute;
      left: -6px;
      bottom: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-top: 10px solid black;
}

/* the container we place inside the grid so it aligns with columns 2..7 */
.diagram-in-grid {
  grid-column: 2 / 8; /* align under the 6 bunker columns */
  padding: 6px;
}

/* make summary fixed to the right side of the page (keeps same class name) */
.summary-table {
  position: fixed;
  right: 250px;
  top: 140px; /* below navbar */
  z-index: 9998;
}

    #loader { display:none; color:var(--muted); margin-top:4px; font-size:0.8rem; }

    /* Media query for screens smaller than 900px */
@media (max-width: 900px) {
  body {
    padding: 80px 6px 6px;
  }

  .main-container {
    max-width: 100%;
    align-items: stretch; /* allow children to expand full width on mobile */
  }

  .mills-grid {
    grid-template-columns: 1fr; /* stack columns vertically */
    gap: 6px;
    font-size: 0.72rem;
  }

  .mill {
    width: 100%;
    min-height: 28px;
    font-size: 0.72rem;
    padding: 4px;
  }

  .dropdown,
  .percentage-input,
  .flow-input,
  .cost-input,
  .gcv-box,
  .generation-input {
    width: 100%;
    font-size: 0.72rem;
    padding: 4px;
  }

  /* when stacked, diagram goes full width and summary sits below */
  .diagram-in-grid { grid-column: 1 / -1; }
  .diagram-in-grid .layout { transform: scale(0.9); }

  .diagram-row {
    flex-direction: column;
    gap: 12px;
  }

  .diagram-row .layout {
    transform: scale(0.7); /* scale diagram for smaller screen */
    width: 100%;
  }

  /* MAIN CHANGE: make the summary table static and full-width on mobile
     This lets it sit below the main content in the DOM (so it appears under the table)
     and allow the page to scroll naturally when content is tall. */
  .summary-table {
    position: static !important;
    right: auto !important;
    top: auto !important;
    z-index: auto;
    width: 100% !important;
    max-width: 100%;
    margin: 12px 0 18px 0;
    grid-template-columns: 1fr 1fr; /* 2-column layout that fits mobile */
    gap: 8px;
    padding: 6px;
    box-sizing: border-box;
  }

  .top-line {
    width: 100%; /* stretch top line */
    left: 0;
  }

  .arrow {
    left: auto !important; /* remove fixed left positions */
    margin-left: calc(50% - 1px); /* center arrows */
  }

  #downloadPDF {
    top: auto;
    bottom: 20px;
    right: 10px;
  }

  .navbar img {
    height: 60px; /* reduce logo size */
  }

  .navbar h1 {
    font-size: 16px;
  }

  .nav-buttons {
    flex-direction: column;
    gap: 6px;
    margin-right: 0;
  }
}
/* ---------- responsive summary fixes (paste at end of your stylesheet) ---------- */

/* 1) On large screens keep the summary fixed but make main area leave room */
@media (min-width: 1201px) {
  .summary-table {
    position: fixed;
    right: 250px;     /* unchanged desktop position */
    top: 140px;
    width: 260px;
    z-index: 9998;
  }

  /* leave room so fixed summary doesn't overlap content */
  .main-container {
    margin-right: 320px; /* > summary width to avoid overlap on wide screens */
  }
}

/* 2) On medium screens (where collision often happens) drop summary below */
@media (max-width: 1200px) and (min-width: 901px) {
  .summary-table {
    position: static !important;   /* make it part of normal flow */
    width: 320px;                  /* narrower so it fits under content nicely */
    max-width: 100%;
    margin: 12px 0 18px 0;
    z-index: auto;
    grid-template-columns: 1fr 1fr;
    box-sizing: border-box;
  }

  .main-container {
    margin-right: 0; /* remove extra margin */
  }
}

/* 3) Mobile: full-width summary below the table, no overlap, scrollable */
@media (max-width: 900px) {
  .summary-table {
    position: static !important;
    right: auto !important;
    top: auto !important;
    z-index: auto;
    width: 100% !important;
    max-width: 100%;
    margin: 12px 0 18px 0;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 6px;
    box-sizing: border-box;
  }

  .main-container {
    margin-right: 0;
    align-items: stretch; /* so inputs expand full width */
  }
}

/* Optional small tweak: make sure any absolutely-positioned elements inside the layout
   do not overflow into the summary area by allowing the layout to wrap/scale. */
.diagram-in-grid,
.layout {
  max-width: 100%;
  box-sizing: border-box;
  overflow: visible;
}

/* Ensure the page can scroll vertically when summary becomes long on mobile */
html, body {
  height: auto;
  overflow-y: auto;
}


  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
if(localStorage.getItem('isLoggedIn') !== 'true') {
    alert('You must login first!');
    window.location.href = '/login.html'; 
} else {
    document.body.style.display = 'block';
}
    function logoutUser() {
  localStorage.setItem('isLoggedIn', 'false'); 
  window.location.href = 'login.html'; 
}
</script>
</head>
<body>
 <div class="navbar">
    <img src="/images/abhitech-logo.png" alt="Company Logo">
    <h1>COAL BLENDING RATIO</h1>
    <div class="nav-buttons">
      <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
      <button onclick="window.location.href='coal_table.html'">Coal Properties</button>
      <button onclick="window.location.href='model.html'">Model</button>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>
  </div>

  <div style="margin-top:8px;">
    <!-- Replaced upload with Go Back button (same style & location) -->
    <button class="upload-btn" onclick="window.history.back()">Go Back</button>
  </div>

  <div id="loader">Loading... please wait</div>
<button id="downloadPDF" class="icon-btn" title="Download page as PDF">⬇️</button>
  <div class="main-container">
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <!-- changed headers to BUNKER 1..6 -->
      <div class="mill green">BUNKER 1</div>
      <div class="mill green">BUNKER 2</div>
      <div class="mill green">BUNKER 3</div>
      <div class="mill green">BUNKER 4</div>
      <div class="mill green">BUNKER 5</div>
      <div class="mill green">BUNKER 6</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>

      <!-- Row 1: Coal name input & % under mills -->
      <div class="mill"><input type="text" class="dropdown" id="coalName1" placeholder="Coal name"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="5" placeholder="%"></div>
      <div class="mill"><input type="text" id="gcvBox1" class="gcv-box" placeholder="GCV"></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>

      <!-- Row 2: Coal name input -->
      <div class="mill"><input type="text" class="dropdown" id="coalName2" placeholder="Coal name"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="5" placeholder="%"></div>
      <div class="mill"><input type="text" id="gcvBox2" class="gcv-box" placeholder="GCV"></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>

      <!-- Row 3: Coal name input -->
      <div class="mill"><input type="text" class="dropdown" id="coalName3" placeholder="Coal name"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="5" placeholder="%"></div>
      <div class="mill"><input type="text" id="gcvBox3" class="gcv-box" placeholder="GCV"></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>

      <!-- NEW: Diagram row placed inside the grid so it aligns with Bunker 1..6 columns -->
      <div></div>
      <div class="diagram-in-grid" style="padding:8px;">
        <div class="layout">
          <div class="top-line"></div>
    <div class="arrow" style="height:60px; left:40px;"></div>
    <div class="arrow" style="height:60px; left:150px;"></div>
    <div class="arrow" style="height:60px; left:255px;"></div>
    <div class="arrow" style="height:60px; left:365px;"></div>
    <div class="arrow" style="height:60px; left:470px;"></div>
    <div class="arrow" style="height:60px; left:580px;"></div>

          <div class="bunkers-grid">
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 1</div>
            </div>
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 2</div>
            </div>
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 3</div>
            </div>
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 4</div>
            </div>
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 5</div>
            </div>
            <div class="bunker">
              <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
              </svg>
              <div class="label">Bunker 6</div>
            </div>
          </div>
        </div>
      </div>
      <div ></div>
      <div ></div>

      <!-- Row 4: Coal Flow (moved down because diagram inserted above) -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="1" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="2" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="3" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="4" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="5" placeholder="TPH"></div>
      <div></div>
      <div></div>

      <!-- Row 5: AFT (calculated per mill) -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div class="mill aft" data-mill="1">--</div>
      <div class="mill aft" data-mill="2">--</div>
      <div class="mill aft" data-mill="3">--</div>
      <div class="mill aft" data-mill="4">--</div>
      <div class="mill aft" data-mill="5">--</div>
      <div></div>
      <div></div>
    </div>

  </div>

<!-- Summary moved out of diagram-row; class name preserved but it is fixed to the right side -->
<div class="summary-table" aria-hidden="false">
  <div class="summary-cell summary-header">Generation (MW)</div>
  <div class="summary-cell"><input id="generation" class="generation-input" placeholder="MW" /></div>

  <div class="summary-cell summary-header">Total Coal Flow(TPH)</div>
  <div class="summary-cell" id="totalFlow">0</div>

  <div class="summary-cell summary-header">Average GCV(Kcal/kg)</div>
  <div class="summary-cell" id="avgGCV">0</div>

  <div class="summary-cell summary-header">Average AFT(°C)</div>
  <div class="summary-cell" id="avgAFT">--</div>

  <div class="summary-cell summary-header">Heat Rate(Kcal/kWh)</div>
  <div class="summary-cell" id="heatRate">--</div>

  <div class="summary-cell summary-header">Cost/MT</div>
  <div class="summary-cell" id="COSTRATE">--</div>
</div>

<script>
  // removed excel handling — user inputs for coal names and GCVs are used instead.

  // AFT formula exactly as provided (returns a number)
  function calcAFT(ox){
    const total = Object.values(ox).reduce((a,b)=>a+b,0);
    if(total === 0) return 0;
    const sum = (ox["SiO₂"]||0) + (ox["Al₂O₃"]||0);
    let aft = 0;
    if(sum < 55){
      aft = 1245 + (1.1*(ox["SiO₂"]||0)) + (0.95*(ox["Al₂O₃"]||0)) - (2.5*(ox["Fe₂O₃"]||0)) - (2.98*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.89*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (1.7*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
    } else if(sum < 75){
      aft = 1323 + (1.45*(ox["SiO₂"]||0)) + (0.683*(ox["Al₂O₃"]||0)) - (2.39*(ox["Fe₂O₃"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.49*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (2.1*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
    } else {
      aft = 1395 + (1.2*(ox["SiO₂"]||0)) + (0.9*(ox["Al₂O₃"]||0)) - (2.5*(ox["Fe₂O₃"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.2*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (1.7*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
    }
    return Number(aft);
  }

  // main calculations: per-mill blended GCV, per-mill AFT, totals & averages
  function calculateBlended(){
    // coal names (kept but not used for numeric calculations here)
    const coal1Name = document.getElementById("coalName1").value;
    const coal2Name = document.getElementById("coalName2").value;
    const coal3Name = document.getElementById("coalName3").value;

    // GCV inputs entered by user
    const gcv1 = parseFloat(document.getElementById("gcvBox1").value) || 0;
    const gcv2 = parseFloat(document.getElementById("gcvBox2").value) || 0;
    const gcv3 = parseFloat(document.getElementById("gcvBox3").value) || 0;

    // oxide keys (not provided by user, so treated as zero)
    const oxKeys = ["SiO₂","Al₂O₃","Fe₂O₃","CaO","MgO","Na₂O","K₂O","SO₃","TiO₂"];

    let totalFlow = 0;
    let weightedGCV = 0;
    let weightedAFT = 0;
    let contributedAFTFlow = 0; // flow that contributed to aft average

    for(let m = 0; m < 6; m++){
      const p1 = parseFloat( document.querySelector(`.percentage-input[data-row="1"][data-mill="${m}"]`)?.value ) || 0;
      const p2 = parseFloat( document.querySelector(`.percentage-input[data-row="2"][data-mill="${m}"]`)?.value ) || 0;
      const p3 = parseFloat( document.querySelector(`.percentage-input[data-row="3"][data-mill="${m}"]`)?.value ) || 0;

      const blendedGCV = (gcv1 * (p1/100)) + (gcv2 * (p2/100)) + (gcv3 * (p3/100));

      // oxides unavailable -> treated as 0 for each coal -> overall ox sum = 0
      let ox = {};
      let oxTotal = 0;
      oxKeys.forEach(k => {
        ox[k] = 0;
        oxTotal += 0;
      });

      const aftCell = document.querySelector(`.aft[data-mill="${m}"]`);
      if(aftCell){
        if(oxTotal === 0){
          // no oxide data -> show placeholder (same behavior as before)
          aftCell.innerText = "--";
        } else {
          const aftVal = calcAFT(ox);
          aftCell.innerText = isFinite(aftVal) ? Number(aftVal).toFixed(2) : "--";
        }
      }

      const flow = parseFloat( document.querySelector(`.flow-input[data-mill="${m}"]`)?.value ) || 0;

      if(flow > 0){
        totalFlow += flow;
        weightedGCV += (flow * blendedGCV);

        // only add to weightedAFT if we have a numeric aft value (we don't here)
        const aftText = aftCell ? aftCell.innerText : "--";
        const aftValNumeric = (aftText !== "--") ? (parseFloat(aftText) || 0) : null;
        if(aftValNumeric !== null){
          weightedAFT += (flow * aftValNumeric);
          contributedAFTFlow += flow;
        }
      }
    }

    const avgGCV = totalFlow > 0 ? (weightedGCV / totalFlow) : 0;
    const avgAFT = (contributedAFTFlow > 0) ? (weightedAFT / contributedAFTFlow) : null;

    document.getElementById("totalFlow").innerText = Number(totalFlow).toFixed(2);
    document.getElementById("avgGCV").innerText = totalFlow>0 ? Number(avgGCV).toFixed(2) : 0;
    document.getElementById("avgAFT").innerText = (avgAFT !== null) ? Number(avgAFT).toFixed(2) : "--";

    const generation = parseFloat(document.getElementById("generation").value) || 0;
    if(generation > 0 && totalFlow > 0){
      const heatRate = (totalFlow * avgGCV) / generation;
      document.getElementById("heatRate").innerText = Number(heatRate).toFixed(2);
    } else {
      document.getElementById("heatRate").innerText = "--";
    }

    function getCoalQty(rowIndex) {
      let total = 0;
      for (let m = 0; m < 6; m++) {
        const perc = parseFloat(document.querySelector(`.percentage-input[data-row="${rowIndex}"][data-mill="${m}"]`)?.value) || 0;
        total += perc; 
      }
      return total;
    }

    const cost1 = parseFloat(document.getElementById("costBox1").value) || 0;
    const cost2 = parseFloat(document.getElementById("costBox2").value) || 0;
    const cost3 = parseFloat(document.getElementById("costBox3").value) || 0;

    const qty1 = getCoalQty(1);
    const qty2 = getCoalQty(2);
    const qty3 = getCoalQty(3);

    const totalCost = (qty1 * cost1) + (qty2 * cost2) + (qty3 * cost3);
    const totalQty  = qty1 + qty2 + qty3;
    const costRate  = totalQty > 0 ? (totalCost / totalQty) : 0;

    document.getElementById("COSTRATE").innerText = costRate.toFixed(2);
  }

  // new: validate sums and update header colors
  function validateMillPercentages() {
    for (let m = 0; m < 6; m++) {
      let hasPercent = false;

      // check if any percent input > 0 for this mill
      for (let r = 1; r <= 3; r++) {
        const val = parseFloat(
          document.querySelector(`.percentage-input[data-row="${r}"][data-mill="${m}"]`)?.value
        ) || 0;
        if (val > 0) {
          hasPercent = true;
          break;
        }
      }

      // check the coal flow for this mill
      const flow = parseFloat(
        document.querySelector(`.flow-input[data-mill="${m}"]`)?.value
      ) || 0;

      const header = Array.from(document.querySelectorAll(".mills-grid > .mill"))
        .find(el => el.textContent.trim().startsWith(`BUNKER ${m+1}`));

      if (!header) continue;

      // reset
      header.classList.remove("red", "green");

      if (hasPercent && flow > 0) {
        header.classList.add("red");
      } else {
        header.classList.add("green");
      }
    }
  }

  function attachAutoUpdate(){
    // add focus + input handlers for percentage inputs to track previous value and validate
    document.querySelectorAll(".percentage-input").forEach(inp => {
      // store initial prev value
      inp.dataset.prev = inp.value || "";

      inp.addEventListener("focus", function(e){
        // store previous value before editing
        this.dataset.prev = this.value;
      });

      inp.addEventListener("input", function(e){
        const raw = this.value.trim();
        let num = parseFloat(raw);
        if (raw === "" || isNaN(num)) num = 0;

        // compute new sum for this mill
        const millIndex = Number(this.dataset.mill);
        let sum = 0;
        for (let r = 1; r <=3; r++){
          const v = parseFloat(document.querySelector(`.percentage-input[data-row="${r}"][data-mill="${millIndex}"]`)?.value) || 0;
          sum += v;
        }

        if (sum > 100) {
          // revert to previous value and notify
          const prev = this.dataset.prev ?? "";
          this.value = prev;
          alert(`Total for Mill ${String.fromCharCode(65+millIndex)} cannot exceed 100%.`);
          // update blended calculations and header colors after revert
          calculateBlended();
          validateMillPercentages();
          updateBunkerColors();
          return;
        }

        // valid, save as prev
        this.dataset.prev = this.value;
        // update calculations & visuals
        calculateBlended();
        validateMillPercentages();
        updateBunkerColors();
      });
    });

    // inputs that affect calculation
    document.querySelectorAll(".flow-input, #generation, .cost-input, .gcv-box, .dropdown").forEach(inp => {
      inp.addEventListener("input", () => { calculateBlended(); validateMillPercentages(); updateBunkerColors(); });
    });

    // initial update
    calculateBlended();
    validateMillPercentages();
    updateBunkerColors();
  }

  // allow the upload-btn (now Go Back) to keep same style - already a button
  attachAutoUpdate();

 document.getElementById("downloadPDF").addEventListener("click", function () {
  const { jsPDF } = window.jspdf;
  const element = document.body; // ✅ capture whole page including navbar

  html2canvas(element, {
    scale: 2,
    useCORS: true,
    onclone: (clonedDoc) => {
      // Handle input & textarea values
      const inputs = clonedDoc.querySelectorAll("input, textarea");
      inputs.forEach(input => {
        const text = clonedDoc.createElement("span");
        text.textContent = input.value;

        text.style.position = "absolute";
        text.style.left = (input.offsetLeft) + "px";
        text.style.top = (input.offsetTop) + "px";
        text.style.width = input.offsetWidth + "px";
        text.style.height = input.offsetHeight + "px";
        text.style.lineHeight = input.offsetHeight + "px";
        text.style.textAlign = "center";
        text.style.font = window.getComputedStyle(input).font;
        text.style.color = window.getComputedStyle(input).color;

        clonedDoc.body.appendChild(text);
        input.style.visibility = "hidden";
      });

      // Handle select dropdowns (if any) - none in this version but keep for compatibility
      const selects = clonedDoc.querySelectorAll("select");
      selects.forEach(select => {
        const selectedText = select.options[select.selectedIndex]?.text || "";
        const text = clonedDoc.createElement("span");
        text.textContent = selectedText;

        text.style.position = "absolute";
        text.style.left = select.offsetLeft + "px";
        text.style.top = select.offsetTop + "px";
        text.style.width = select.offsetWidth + "px";
        text.style.height = select.offsetHeight + "px";
        text.style.lineHeight = select.offsetHeight + "px";
        text.style.textAlign = "center";
        text.style.font = window.getComputedStyle(select).font;
        text.style.color = window.getComputedStyle(select).color;

        clonedDoc.body.appendChild(text);
        select.style.visibility = "hidden";
      });
    }
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    pdf.save("Coal_Blending_Ratio.pdf");
  });
});


// draws bunker fills based on percentage inputs (unchanged logic)
function updateBunkerColors() {
  const coalColors = ["#f39c12", "#3498db", "#2ecc71"]; // row 1,2,3
  const numBunkers = 6;

  // Coordinates (same scale as your SVG viewBox)
  const svgWidth = 100;
  const svgHeight = 150;
  const topY = 10;
  const midY = 100;   // where sides start slanting
  const bottomY = 140;
  const usableH = bottomY - topY; // 130

  // closed outline used only for clipping (fills)
  const outlinePath = `M10 ${topY} L10 ${midY} L45 ${bottomY} L55 ${bottomY} L90 ${midY} L90 ${topY} Z`;

  for (let b = 0; b < numBunkers; b++) {
    const bunker = document.querySelectorAll(".bunker")[b];
    if (!bunker) continue;
    const svg = bunker.querySelector("svg");
    if (!svg) continue;

    // read percentages
    const p1 = parseFloat(document.querySelector(`.percentage-input[data-row="1"][data-mill="${b}"]`)?.value) || 0;
    const p2 = parseFloat(document.querySelector(`.percentage-input[data-row="2"][data-mill="${b}"]`)?.value) || 0;
    const p3 = parseFloat(document.querySelector(`.percentage-input[data-row="3"][data-mill="${b}"]`)?.value) || 0;
    const percentages = [p1, p2, p3];

    // build svg content
    const clipId = `clip-bunker-${b}`;
    let svgInner = `<defs><clipPath id="${clipId}"><path d="${outlinePath}" /></clipPath></defs>`;

    // stacking from bottom up
    let cumHeight = 0;
    const rects = [];
    for (let i = 0; i < percentages.length; i++) {
      const pct = Math.max(0, Math.min(100, percentages[i]));
      if (pct === 0) continue;
      const h = (pct / 100) * usableH;
      const y = bottomY - (cumHeight + h);
      cumHeight += h;
      // full-width rect clipped by the bunker clipPath
      rects.push(`<rect x="0" y="${y}" width="${svgWidth}" height="${h}" fill="${coalColors[i]}" clip-path="url(#${clipId})" />`);
    }
    svgInner += rects.join("\n");

    // draw outline segments (only the lines you want)
    svgInner += `<path d="M10 ${topY} L10 ${midY}" stroke="black" fill="none" stroke-width="2" />`;
    svgInner += `<path d="M90 ${topY} L90 ${midY}" stroke="black" fill="none" stroke-width="2" />`;
    svgInner += `<path d="M10 ${midY} L45 ${bottomY}" stroke="black" fill="none" stroke-width="2" />`;
    svgInner += `<path d="M90 ${midY} L55 ${bottomY}" stroke="black" fill="none" stroke-width="2" />`;

    svg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);
    svg.innerHTML = svgInner;
  }
}
</script>
<!-- paste into input.html (before </body>) -->
<script>
(function(){
  const STORAGE_KEY = 'coalBlending_inputData';
  const DEBOUNCE_MS = 250;
  let timer = null;

  function collectState(){
    const rows = [];
    // we assume 3 coal rows as in your file (coalName1..3). Adjust if you have more.
    for (let r = 1; r <= 3; r++){
      const coalEl = document.getElementById(`coalName${r}`) || document.getElementById(`coalDrop${r}`);
      const coalName = coalEl ? coalEl.value : '';
      const percentages = [];
      for (let m = 0; m < 6; m++){
        const p = document.querySelector(`.percentage-input[data-row="${r}"][data-mill="${m}"]`);
        percentages.push(p ? (p.value || '') : '');
      }
      const gcvEl = document.getElementById(`gcvBox${r}`);
      const gcvVal = gcvEl ? (gcvEl.value !== undefined ? gcvEl.value : gcvEl.textContent) : '';
      const costEl = document.getElementById(`costBox${r}`);
      const costVal = costEl ? (costEl.value || '') : '';
      rows.push({ coal: coalName, percentages, gcv: gcvVal, cost: costVal });
    }

    // collect flows (6 mills)
    const flows = [];
    const flowEls = document.querySelectorAll('.flow-input');
    flowEls.forEach(f => flows.push(f.value || ''));

    // generation if present
    const genEl = document.getElementById('generation');
    const generation = genEl ? (genEl.value || '') : '';

    return { rows, flows, generation, ts: Date.now() };
  }

  function saveState(){
    const state = collectState();
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e){ console.error('Cannot save input state', e); }
  }

  function debounceSave(){
    clearTimeout(timer);
    timer = setTimeout(saveState, DEBOUNCE_MS);
  }

  // attach listeners to inputs/selects present on the page
  function attach(){
    const els = Array.from(document.querySelectorAll('input[type="text"], input[type="number"], textarea, select'));
    els.forEach(el => {
      el.addEventListener('input', debounceSave, {passive:true});
      el.addEventListener('change', debounceSave, {passive:true});
    });
    // initial save
    saveState();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach);
  else attach();
})();
</script>

</body>
</html>
